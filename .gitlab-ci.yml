stages:
  - trigger_downstream_merge_requests

variables:
  DOWNSTREAM_REPOS: "gomogi/indrz/aau/indrz-frontend-aau,gomogi/indrz/wu/indrz-frontend-wu"  # Comma-separated list of downstream repositories
  MILESTONE_NAME: "v3.1.1"  # The name of the milestone you want to associate with

trigger_downstream_merge_requests:
  stage: trigger_downstream_merge_requests
  only:
    refs:
      - main
  script:
    - apt-get update -qy
    - apt-get install -y jq curl
    - >
      for downstream_repo in $(echo $DOWNSTREAM_REPOS | tr "," "\n"); do
        echo "Processing downstream repository: $downstream_repo";
        
        # Fetch the milestone ID
        milestones=$(curl -s --header "PRIVATE-TOKEN: $PRIVATE_ACCESS_TOKEN" "https://gitlab.com/api/v4/projects/$downstream_repo/milestones")
        milestone_id=$(echo "$milestones" | jq -r --arg MILESTONE_NAME "$MILESTONE_NAME" '.[] | select(.title==$MILESTONE_NAME) | .id')
        
        if [ -z "$milestone_id" ]; then
          echo "Milestone not found. Skipping..."
          continue
        fi

        # Check if a merge request already exists
        existing_mr=$(curl -s --header "PRIVATE-TOKEN: $PRIVATE_ACCESS_TOKEN" "https://gitlab.com/api/v4/projects/$downstream_repo/merge_requests?state=opened&source_branch=main&target_branch=main")

        if [ $(echo "$existing_mr" | jq 'length') -eq 0 ]; then
          # Create new merge request with milestone
          response=$(curl -s --request POST "https://gitlab.com/api/v4/projects/$downstream_repo/merge_requests" \
            --header "PRIVATE-TOKEN: $PRIVATE_ACCESS_TOKEN" \
            --form "source_branch=main" \
            --form "target_branch=main" \
            --form "milestone_id=$milestone_id" \
            --form "title=Automated Merge Request" \
            --form "description=This is an automated merge request triggered by an update to the main repository.")

          if [ $(echo "$response" | jq -r '.id') ]; then
            echo "Merge request with milestone created successfully."
          else
            echo "Failed to create merge request. Response: $response"
          fi
        else
          echo "Merge request already exists. Skipping..."
        fi
      done
